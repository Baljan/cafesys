{% extends "baljan/baljan.html" %}
{% load i18n %}
{% load static %}
{% load humanize %}
{% load crispy_forms_tags %}
{% load baljan_extras %}

{% block head_title %}Kaffekort{% endblock %}

{% block body_class %}credits{% endblock %}
{% block body %}
    {% if not works_automatically %}
        <div class="alert alert-danger" role="alert">
            <h2>LiU-kort fungerar <u>inte</u> automatiskt</h2>
            <p>
                Du har tagit avstånd från lagring av personlig information och vi kan därför inte
                koppla ditt LiU-kort till blippen automatiskt. För att kunna använda blippen måste
                du därför fylla i ditt LiU-kortnummer manuellt i din <a href="{% url 'profile' %}">profil</a>.
                Där är det också möjligt att ändra din åsikt i frågan om datalagring.
            </p>
        </div>
    {% else %}
        <div class="alert alert-warning" role="alert">
            <h2>LiU-kort fungerar snart inte längre automatiskt</h2>
            <p>
                På grund av den nya dataskyddsförordningen kommer det externa system vi använder för
                att hämta LiU-kortnummer stängas ner den 24:e maj. För att fortsätta blippen därefter
                måste du fylla i ditt kortnummer manuellt i din <a href="{% url 'profile' %}">profil</a>.
            </p>
            <p>
                Har du godkänt att vi cache-lagrar ditt kortnummer automatiskt så behöver du bara
                blippa ditt kort nere i Baljan en gång innan den 24:e maj, så kommer allting att fortsätta fungera
                precis som förut. Detta kan du ta ställning till i din <a href="{% url 'profile' %}">profil</a>.
            </p>
        </div>
    {% endif %}

    <h1>Konto</h1>
    <div class="row">
        <div class="col-sm-6">
            <h2>Fylla på</h2>
            <p>
                Värdekort kan köpas på kafét.
                Om du har frågor eller stöter på problem, <a href="mailto:{{CONTACT_EMAIL}}">kontakta oss</a>.
                Missbruk loggas.
            </p>
            {% if used_card %}
                <div class="alert alert-success">
                    Koden användes.
                </div>
            {% endif %}

            {% if invalid_card %}
                <div class="alert alert-danger">
                    Ogiltig eller använd kod.
                </div>
            {% endif %}
            <form autocomplete="off" method="POST" action="">{% csrf_token %}
                <input type="hidden" name="task" value="refill" />
                <div class="form-group">
                    {{refill_form}}
                    <small class="form-text text-muted">Koden står på ditt värdekort.</small>
                </div>
                <input type="submit" class="btn btn-primary" value="Fyll på"/>
            </form>

        </div>
        <div class="col-sm-6">
            <h2>Tillgängligt</h2>
            <p>{{currently_available}}</p>

            {% if works_automatically %}
                <h2>LiU-kort fungerar automatiskt</h2>
                <p>
                    LiU-kort hämtas automatiskt från universitetets databaser.
                    Det tar dock någon dag för ett nytt kort att komma in i databasen om du byter kort.
                </p>
            {% endif %}

            <h2>Använda värdekort</h2>
            <ul>
                {% for card in used_cards %}
                    <li>
                    Kort: {{card.serid}} värt {{card.valcur }} användes {{card.used_at|date}}
                    {% if card.refill_series.add_to_group %}
                        (Du blev tillagd till {{card.refill_series.add_to_group.name}})
                    {% endif %}
                    </li>
                {% empty %}
                    <li>Du har inte använt några värdekort.</li>
                {% endfor %}
            </ul>
        </div>
    </div>

{% endblock %}

{% block extra_body %}
{% endblock %}
