{% extends "baljan/baljan.html" %}
{% load i18n %}
{% load humanize %}
{% load uni_form_tags %}
{% load baljan_extras %}

{# “user” refers to the logged in user, therefore “watched” is used instead. #}
{% block head_title %}{{watched.get_full_name}}{% endblock %}

{% block body_class %}user{% endblock %}
{% block body %}
<div class="row">
	<div class="col-xs-12">
		<h1>{{watched.get_full_name}} ({{watched.username}})</h1>
	</div>
</div>
<div class="row">
	<div class="col-md-6">
		<div class="alert alert-success">
			{% if watching_self %}
				<p>{% trans "This is you" %}</p>
			{% else %}
				{% if are_friends %}
					{% blocktrans %}
					<p>
					<strong>You are friends</strong>
					and can sign each other up for work shifts
					</p>
					{% endblocktrans %}
				{% else %}
					{% url baljan.views.toggle_friend_request watched.username request.path as request_link %}
					{% if pending_friends %}
						{% if pending_friends.sent_by == watched %}
							<p>
								{% trans "user wants to be friends with you" %}:
								<a class="deny" href="{% url baljan.views.deny_friend_request_from watched request.path %}">{% trans "deny" %}</a> /
								<a class="accept" href="{% url baljan.views.accept_friend_request_from watched request.path %}">{% trans "accept" %}</a>
							</p>
						{% else %}
							<p>
							{% trans "awaiting friend confirmation" %}
							(<a href="{{request_link}}">cancel</a>)
							</p>
						{% endif %}
					{% else %}
						<p><a href="{{request_link}}">{% trans "send friend request" %}</a></p>
					{% endif %}
					<p>
					{% trans "(friends can sign each other up for work shifts)" %}
					</p>
				{% endif %}
			{% endif %}
		</div>

		{% if profile_forms %}
			<div class="pull-right">
				<button type="button" class="btn btn-link" data-toggle="modal" data-target="#profileModal">{% trans "Edit" %}</button>
			</div>
		{% endif %}
		<h2>{% trans "profile"|title %}</h2>
		{% with watched.get_profile as prof %}
		{% if prof.picture %}
    <div class="row">
      <div class="col-sm-6 col-sm-offset-3">
        <div class="picture">
          <img src="{{MEDIA_URL}}{{prof.picture}}" class="img-responsive img-rounded" alt="{% trans 'Profile picture' %}">
        </div>
      </div>
    </div>
		{% endif %}
		
		<table class="table">
			<tbody>
				<tr>
					<th>{% trans "Name" %}</th>
					<td>{{watched.get_full_name}}</td>
				</tr>
				{% if watching_self or perms.baljan.self_and_friend_signup %}
				<tr>
					<th>{% trans "Phone" %}</th>
					{% if prof.mobile_phone %}
					<td><a href="tel:{{prof.mobile_phone }}">{{prof.mobile_phone }}</a></td>
					{% else %}
					<td>{% trans "Not set." %}</td>
					{% endif %}
				</tr>
				{% endif %}
				<tr>
					<th>{% trans "Last login" %}</th>
					<td>{{watched.last_login|date}} {{watched.last_login|time}}</td>
				</tr>
				{% if watching_self %}
				<tr>
					<th>{% trans "Calendar" %}</th>
					<td><a href="{% url baljan.views.user_calendar watched.get_profile.private_key %}">{% trans "iCal format" %}</a></td>
				</tr>
				<tr>
					<th>{% trans "Motto" %}</th>
					{% if prof.motto %}
					<td>{{ prof.motto }}</td>
					{% else %}
					<td>{% trans "None set. It is displayed in the high scores." %}</td>
					{% endif %}
				</tr>
				<tr>
					<th>{% trans "Section" %}</th>
					{% if prof.section %}
					<td>{{ prof.section.name }}</td>
					{% else %}
					<td>{% trans "None set." %}</td>
					{% endif %}
				</tr>
				{% endif %}
			</tbody>
		</table>
		{% endwith %}

		{% with watched_groups as groups %}
		<h2>{% trans "Groups" %}</h2>
		{% if groups|length %}
			<ul>
			{% for group in groups %}
				<li><a href="{% url group group.name %}">{{ group.name }}</a></li>
			{% endfor %}
			</ul>
		{% else %}
			{% url become_worker as become_worker_link %}
			<p>
			{% blocktrans %}
			None. To work in Baljan, one must <a href="{{become_worker_link}}">become a member of the workers' group</a>.
			{% endblocktrans %}
			</p>
		{% endif %}
		{% endwith %}

		{% if friends %}
			<h2>{% trans "Friends" %}</h2>
			<ul>
				{% for friend in friends %}
					<li>{{friend|user_link}}</li>
				{% endfor %}
			</ul>
		{% endif %}
	</div>

	<div class="col-md-6">
		{% if perms.auth.change_user %}
		<div class="pull-right">
			{% trans "Admin" %}: 
			<a href="{% url admin:auth_user_change watched.id %}">{% trans "User" %}</a>,
			<a href="{% url admin:baljan_profile_change watched.get_profile.id %}">{% trans "Profile" %}</a>
		</div>
		{% endif %}

		{% if join_group_requests %}
		<h2>{% trans "Requesting to Join" %}</h2>
		{% for jgr in join_group_requests %}
		<div class="row">
			<div class="col-xs-9">
				<a href="{% url group jgr.group %}">{{jgr.group.name}}</a>
			</div>
			<div class="col-xs-3">
				<a href="{% url baljan.views.toggle_become_worker_request request.path %}">{% trans "Recall" %}</a>
			</div>
		</div>
		{% endfor %}
		{% endif %}

		{% if trade_requests %}
		<h2>{% trans "Trade Requests" %}</h2>
		{% if received_trade_requests %}
		<h3>{% trans "Received" %}</h3>
		<table class="table">
			<thead>
				<tr>
					<th>{% trans "Wanted" %}</th>
					<th>{% trans "Offered" %}</th>
					<th>{% trans "From" %}</th>
					<th colspan="2">{% trans "Answer" %}</th>
				</tr>
			</thead>
			<tbody>
			{% for recd in received_trade_requests %}
			<tr>
				{% with recd.wanted_signup as wanted %}
					<td>
						{% ifchanged wanted %}
							{{wanted|shift_link_short}}
						{% endifchanged %}
					</td>
				{% endwith %}
				{% with recd.offered_signup as offered %}
					<td>
						{% ifchanged offered %}
							{{offered|shift_link_short}}
						{% endifchanged %}
					</td>
					<td>
						{{offered|name_link}}
					</td>
				{% endwith %}
				<td>
					<a href="{% url deny_trade recd.pk request.path %}">{% trans "Deny" %}</a>
				</td>
				<td>
					<a href="{% url accept_trade recd.pk request.path %}">{% trans "Accept" %}</a>
				</td>
			</tr>
			{% endfor %}
			</tbody>
		</table>
		{% endif %}

		{% if sent_trade_requests %}
		<h3>{% trans "Sent" %}</h3>
		<table class="table">
			<thead>
				<tr>
					<th>{% trans "Wanted" %}</th>
					<th>{% trans "Offered" %}</th>
					<th>{% trans "To" %}</th>
					<th>{% trans "Action" %}</th>
				</tr>
			</thead>
			<tbody>
			{% for sent in sent_trade_requests %}
			<tr>
				{% with sent.wanted_signup as wanted %}
					<td>
						{% ifchanged wanted %}
							{{wanted|shift_link_short}}
						{% endifchanged %}
					</td>
					{% with sent.offered_signup as offered %}
					<td>
						{% ifchanged offered %}
							{{offered|shift_link_short}}
						{% endifchanged %}
					</td>
					<td>
						{{wanted|name_link}}
					</td>
					{% endwith %}
					<td class="action">
						{% ifchanged wanted %}
							<a href="{% url baljan.views.trade_take wanted.pk request.path%}">{% trans "Edit" %}</a>
						{% endifchanged %}
					</td>
				{% endwith %}
			</tr>
			{% endfor %}
			</tbody>
		</table>
		{% endif %}
		{% endif %}


		{% if received_friend_requests %}
		<h2>{% trans "Received Friend Requests From" %}</h2>
		{% for fr in received_friend_requests %}
		<div class="row">
			<div class="col-xs-9">
				<a href="{{fr.sent_by.get_absolute_url}}">{{fr.sent_by.get_full_name}} ({{fr.sent_by.username}})</a>
			</div>
			<div class="col-xs-3">
				<a href="{% url baljan.views.deny_friend_request_from fr.sent_by request.path %}">{% trans "Deny" %}</a> /<a href="{% url baljan.views.accept_friend_request_from fr.sent_by request.path %}">{% trans "Accept" %}</a>
			</div>
		</div>
		{% endfor %}
		{% endif %}

		{% if sent_friend_requests %}
		<h2>{% trans "Awaiting Friend Confirmations From" %}</h2>
		{% for fr in sent_friend_requests %}
		<div class="row">
			<div class="col-xs-9">
				<a href="{{fr.sent_to.get_absolute_url}}">{{fr.sent_to.get_full_name}} ({{fr.sent_to.username}})</a>
			</div>
			<div class="col-xs-3">
				<a href="{% url baljan.views.toggle_friend_request fr.sent_to request.path %}">{% trans "Cancel" %}</a>
			</div>
		</div>			
		{% endfor %}
		{% endif %}
		
		{% for type_title, type_classes, grouped_signups in signup_types %}
		{% if grouped_signups|length %}
		<h2>{{ type_title|title }}</h2>
		<table class="table table-condensed">
			<thead>
				<tr>
					<th>{% trans "Semester" %}</th>
					<th>{% trans "Date" %}</th>
					<th>{% trans "Am/Pm" %}</th>
				</tr>
			</thead>
			<tbody>
			{% for gtitle, gclass, gsignups in grouped_signups %}
				<tr class="group {{glclass|join:" "}}"><td colspan="3">{{gtitle}}</td></tr>
				{% for signup in gsignups %}
					<tr>
						{% with signup.shift as shift %}
						<td>
							{% with shift.semester as sem %}
								{% ifchanged sem %}
								<a href="{{sem.get_absolute_url}}">{{sem.name}}</a>
								{% endifchanged %}
							{% endwith %}
						</td>
						<td class="{% if signup.can_trade %}tradable{% endif %}">
							<a href="{{shift.get_absolute_url}}">{{shift.when|naturalday}}</a>
						</td>
						<td>
							{{ shift.ampm }}
						</td>
						{% endwith %}
					</tr>
				{% endfor %}
			{% endfor %}
			</tbody>
		</table>
		{% endif %}
		{% endfor %}
	</div>
</div>
        
{% if profile_forms %}
<div class="modal fade" id="profileModal" tabindex="-1" role="dialog" aria-labelledby="profileModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<form enctype="multipart/form-data" class="form-horizontal" method="POST" action="">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="{% trans 'Close' %}"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="profileModalLabel">{% trans "Edit Profile" %}</h4>
				</div>
				<div class="modal-body">
					{% csrf_token %}
					<table>
					{% for profile_form in profile_forms %}
						{% for row in profile_form %}
							<div class="form-group">
								<label for="{{ row.id_for_label }}" class="col-sm-4 control-label">{{ row.label }}</label>
								<div class="col-sm-8">
									{{ row }}
								</div>
							</div>
						{% endfor %}
					{% endfor %}
					</table>
				</div>
				<div class="modal-footer">
					<button type="submit" class="btn btn-primary">{% trans 'Spara' %}</button>
					<button type="button" class="btn btn-default" data-dismiss="modal">{% trans 'Cancel' %}</button>
				</div>
			</form>
		</div>
	</div>
</div>
{% endif %}


{% endblock %}

{% block extra_body %}
<script type="text/javascript">
// <![CDATA[
    SAVE_MSG = "{% trans "save" %}";
    CANCEL_MSG = "{% trans "cancel" %}";
    CONFIRM_MSG = "{% trans "Are you sure?" %}";
    CONFIRM_SIGNUP = "{% trans "This cannot be undone. Are you sure?" %}";
    CONFIRM_DELETE = CONFIRM_MSG;
// ]]>
</script>
{% endblock %}
